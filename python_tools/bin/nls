#!/usr/bin/env python3
"""
nls - List Z1 cluster compute nodes

Unix-style utility to list all compute nodes in the NeuroFab Z1 cluster.
"""

import sys
import os
import argparse
import json

# Add lib directory to path
sys.path.insert(0, os.path.join(os.path.dirname(__file__), '..', 'lib'))

from z1_client import Z1Client, Z1ClusterError, format_memory_size, format_uptime


def main():
    parser = argparse.ArgumentParser(
        description='List all compute nodes in the Z1 cluster',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  nls                    List all nodes
  nls -v                 Verbose output with memory info
  nls -j                 JSON output for scripting
  nls -c 192.168.1.100   Use custom controller IP
        """
    )
    
    parser.add_argument('-c', '--controller', 
                       default='192.168.1.222',
                       help='Controller IP address (default: 192.168.1.222)')
    parser.add_argument('-v', '--verbose',
                       action='store_true',
                       help='Show detailed node information')
    parser.add_argument('-j', '--json',
                       action='store_true',
                       help='Output in JSON format')
    
    args = parser.parse_args()
    
    try:
        client = Z1Client(controller_ip=args.controller)
        nodes = client.list_nodes()
        
        if args.json:
            # JSON output
            output = {
                'controller': args.controller,
                'node_count': len(nodes),
                'nodes': [
                    {
                        'id': node.node_id,
                        'status': node.status,
                        'memory_free': node.memory_free,
                        'uptime_ms': node.uptime_ms,
                        'led_state': node.led_state
                    }
                    for node in nodes
                ]
            }
            print(json.dumps(output, indent=2))
        
        elif args.verbose:
            # Verbose output
            print(f"Z1 Cluster Nodes (Controller: {args.controller})")
            print("=" * 80)
            print(f"Total nodes: {len(nodes)}\n")
            
            for node in nodes:
                print(f"Node {node.node_id:2d}:")
                print(f"  Status:      {node.status}")
                print(f"  Memory Free: {format_memory_size(node.memory_free)}")
                print(f"  Uptime:      {format_uptime(node.uptime_ms)}")
                print(f"  LED State:   R={node.led_state['r']:3d} "
                      f"G={node.led_state['g']:3d} "
                      f"B={node.led_state['b']:3d}")
                print()
        
        else:
            # Standard output
            print(f"NODE  STATUS    MEMORY      UPTIME")
            print("-" * 50)
            for node in nodes:
                print(f"{node.node_id:4d}  {node.status:8s}  "
                      f"{format_memory_size(node.memory_free):10s}  "
                      f"{format_uptime(node.uptime_ms):>10s}")
            
            print(f"\nTotal: {len(nodes)} nodes")
        
        return 0
        
    except Z1ClusterError as e:
        print(f"Error: {e}", file=sys.stderr)
        return 1
    except KeyboardInterrupt:
        print("\nInterrupted", file=sys.stderr)
        return 130


if __name__ == '__main__':
    sys.exit(main())

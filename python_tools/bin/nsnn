#!/usr/bin/env python3
"""
nsnn - Manage Spiking Neural Networks on Z1 cluster

Unix-style utility for SNN deployment, monitoring, and control.
"""

import sys
import os
import argparse
import json
import time

# Add lib directory to path
sys.path.insert(0, os.path.join(os.path.dirname(__file__), '..', 'lib'))

from z1_client import Z1Client, Z1ClusterError


def cmd_deploy(client: Z1Client, args):
    """Deploy SNN topology to cluster."""
    # Load topology file
    try:
        with open(args.topology, 'r') as f:
            topology = json.load(f)
    except FileNotFoundError:
        print(f"Error: Topology file not found: {args.topology}", file=sys.stderr)
        return 1
    except json.JSONDecodeError as e:
        print(f"Error: Invalid JSON in topology file: {e}", file=sys.stderr)
        return 1
    
    print(f"Deploying SNN topology from {args.topology}...")
    print(f"  Network: {topology.get('network_name', 'unnamed')}")
    print(f"  Neurons: {topology.get('neuron_count', 0)}")
    print(f"  Layers:  {len(topology.get('layers', []))}")
    
    # Deploy to cluster
    result = client.deploy_snn(topology)
    
    print(f"\nDeployment complete:")
    print(f"  Neurons deployed: {result.get('neurons_deployed', 0)}")
    print(f"  Nodes used:       {result.get('nodes_used', 0)}")
    print(f"  Status:           {result.get('status', 'unknown')}")
    
    return 0


def cmd_status(client: Z1Client, args):
    """Show SNN status."""
    status = client.get_snn_status()
    
    print("SNN Status:")
    print("=" * 60)
    print(f"  State:           {status.get('state', 'unknown')}")
    print(f"  Network:         {status.get('network_name', 'none')}")
    print(f"  Neurons:         {status.get('neuron_count', 0)}")
    print(f"  Active Neurons:  {status.get('active_neurons', 0)}")
    print(f"  Total Spikes:    {status.get('total_spikes', 0)}")
    print(f"  Spike Rate:      {status.get('spike_rate_hz', 0):.2f} Hz")
    print(f"  Nodes Used:      {status.get('nodes_used', 0)}")
    
    return 0


def cmd_start(client: Z1Client, args):
    """Start SNN execution."""
    print("Starting SNN execution...")
    if client.start_snn():
        print("SNN started successfully")
        return 0
    else:
        print("Failed to start SNN", file=sys.stderr)
        return 1


def cmd_stop(client: Z1Client, args):
    """Stop SNN execution."""
    print("Stopping SNN execution...")
    if client.stop_snn():
        print("SNN stopped successfully")
        return 0
    else:
        print("Failed to stop SNN", file=sys.stderr)
        return 1


def cmd_monitor(client: Z1Client, args):
    """Monitor spike activity."""
    duration_ms = args.duration
    
    print(f"Monitoring spike activity for {duration_ms}ms...")
    spikes = client.get_spike_activity(duration_ms)
    
    print(f"\nCaptured {len(spikes)} spikes:")
    print(f"  TIME (Î¼s)    NEURON ID    NODE")
    print(f"  {'-' * 40}")
    
    for spike in spikes[:100]:  # Show first 100
        node_str = f"{spike.node_id}" if spike.node_id is not None else "?"
        print(f"  {spike.timestamp_us:10d}   {spike.neuron_id:8d}    {node_str:4s}")
    
    if len(spikes) > 100:
        print(f"  ... ({len(spikes) - 100} more spikes)")
    
    # Calculate statistics
    if spikes:
        spike_rate = len(spikes) / (duration_ms / 1000.0)
        print(f"\nStatistics:")
        print(f"  Total spikes:  {len(spikes)}")
        print(f"  Spike rate:    {spike_rate:.2f} Hz")
        
        # Unique neurons
        unique_neurons = len(set(s.neuron_id for s in spikes))
        print(f"  Active neurons: {unique_neurons}")
    
    return 0


def cmd_inject(client: Z1Client, args):
    """Inject input spikes."""
    # Load spikes file
    try:
        with open(args.spikes, 'r') as f:
            spikes_data = json.load(f)
    except FileNotFoundError:
        print(f"Error: Spikes file not found: {args.spikes}", file=sys.stderr)
        return 1
    except json.JSONDecodeError as e:
        print(f"Error: Invalid JSON in spikes file: {e}", file=sys.stderr)
        return 1
    
    spikes = spikes_data.get('spikes', [])
    print(f"Injecting {len(spikes)} input spikes...")
    
    count = client.inject_spikes(spikes)
    print(f"Successfully injected {count} spikes")
    
    return 0


def main():
    parser = argparse.ArgumentParser(
        description='Manage Spiking Neural Networks on Z1 cluster',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Commands:
  deploy TOPOLOGY        Deploy SNN from topology JSON file
  status                 Show SNN status and statistics
  start                  Start SNN execution
  stop                   Stop SNN execution
  monitor DURATION       Monitor spike activity (milliseconds)
  inject SPIKES          Inject input spikes from JSON file

Examples:
  nsnn deploy network.json           Deploy SNN topology
  nsnn status                        Show current SNN status
  nsnn start                         Start SNN execution
  nsnn monitor 5000                  Monitor for 5 seconds
  nsnn inject input_pattern.json     Inject input spikes
        """
    )
    
    parser.add_argument('command',
                       choices=['deploy', 'status', 'start', 'stop', 'monitor', 'inject'],
                       help='Command to execute')
    parser.add_argument('args',
                       nargs='*',
                       help='Command arguments')
    parser.add_argument('-c', '--controller',
                       default='192.168.1.222',
                       help='Controller IP address (default: 192.168.1.222)')
    
    args = parser.parse_args()
    
    try:
        client = Z1Client(controller_ip=args.controller)
        
        # Dispatch to command handler
        if args.command == 'deploy':
            if not args.args:
                print("Error: deploy requires topology file argument", file=sys.stderr)
                return 1
            cmd_args = argparse.Namespace(topology=args.args[0])
            return cmd_deploy(client, cmd_args)
        
        elif args.command == 'status':
            cmd_args = argparse.Namespace()
            return cmd_status(client, cmd_args)
        
        elif args.command == 'start':
            cmd_args = argparse.Namespace()
            return cmd_start(client, cmd_args)
        
        elif args.command == 'stop':
            cmd_args = argparse.Namespace()
            return cmd_stop(client, cmd_args)
        
        elif args.command == 'monitor':
            if not args.args:
                print("Error: monitor requires duration argument (ms)", file=sys.stderr)
                return 1
            try:
                duration = int(args.args[0])
            except ValueError:
                print("Error: duration must be an integer", file=sys.stderr)
                return 1
            cmd_args = argparse.Namespace(duration=duration)
            return cmd_monitor(client, cmd_args)
        
        elif args.command == 'inject':
            if not args.args:
                print("Error: inject requires spikes file argument", file=sys.stderr)
                return 1
            cmd_args = argparse.Namespace(spikes=args.args[0])
            return cmd_inject(client, cmd_args)
        
    except Z1ClusterError as e:
        print(f"Error: {e}", file=sys.stderr)
        return 1
    except KeyboardInterrupt:
        print("\nInterrupted", file=sys.stderr)
        return 130


if __name__ == '__main__':
    sys.exit(main())
